{"version":3,"file":"index.cjs","sources":["../src/index.ts"],"sourcesContent":["import { Plugin, ResolvedConfig } from 'vite'\nimport {\n  parseURL,\n  loadImage,\n  builtins,\n  resolveConfigs,\n  applyTransforms,\n  generateTransforms,\n  getMetadata,\n  generateImageID,\n  builtinOutputFormats,\n  urlFormat,\n  extractEntries\n} from 'imagetools-core'\nimport { basename, extname, posix } from 'path'\nimport { createFilter, dataToEsm } from '@rollup/pluginutils'\nimport { VitePluginOptions } from './types'\n\nconst defaultOptions: VitePluginOptions = {\n  include: [\n    '**/*.{heic,heif,avif,jpeg,jpg,png,tiff,webp,gif}',\n    '**/*.{heic,heif,avif,jpeg,jpg,png,tiff,webp,gif}?*'\n  ],\n  exclude: 'public/**/*',\n  silent: false,\n  removeMetadata: true\n}\n\nexport function imagetools(userOptions: Partial<VitePluginOptions> = {}): Plugin {\n  const pluginOptions: VitePluginOptions = { ...defaultOptions, ...userOptions }\n\n  const filter = createFilter(pluginOptions.include, pluginOptions.exclude)\n\n  const transformFactories = pluginOptions.extendTransforms ? pluginOptions.extendTransforms(builtins) : builtins\n\n  const outputFormats = pluginOptions.extendOutputFormats\n    ? pluginOptions.extendOutputFormats(builtinOutputFormats)\n    : builtinOutputFormats\n\n  let viteConfig: ResolvedConfig\n\n  const generatedImages = new Map()\n\n  return {\n    name: 'imagetools',\n    enforce: 'pre',\n    configResolved(cfg) {\n      viteConfig = cfg\n    },\n    async load(id) {\n      if (!filter(id)) return null\n\n      const srcURL = parseURL(id)\n\n      let directives = srcURL.searchParams\n\n      if (typeof pluginOptions.defaultDirectives === 'function') {\n        directives = new URLSearchParams([...pluginOptions.defaultDirectives(srcURL), ...srcURL.searchParams])\n      } else if (pluginOptions.defaultDirectives) {\n        directives = new URLSearchParams([...pluginOptions.defaultDirectives, ...srcURL.searchParams])\n      }\n\n      if (!directives.toString()) return null\n\n      const parameters = extractEntries(directives)\n      const imageConfigs =\n        pluginOptions.resolveConfigs?.(parameters, outputFormats) ?? resolveConfigs(parameters, outputFormats)\n\n      const img = loadImage(decodeURIComponent(srcURL.pathname))\n\n      const outputMetadatas = []\n\n      for (const config of imageConfigs) {\n        const id = generateImageID(srcURL, config)\n\n        const { transforms } = generateTransforms(config, transformFactories)\n        const { image, metadata } = await applyTransforms(transforms, img.clone(), pluginOptions.removeMetadata)\n\n        generatedImages.set(id, image)\n\n        if (!this.meta.watchMode) {\n          const fileName = basename(srcURL.pathname, extname(srcURL.pathname)) + `.${metadata.format}`\n\n          const fileHandle = this.emitFile({\n            name: fileName,\n            source: await image.toBuffer(),\n            type: 'asset'\n          })\n\n          metadata.src = `__VITE_ASSET__${fileHandle}__`\n        } else {\n          metadata.src = posix.join('/@imagetools', id)\n        }\n\n        metadata.image = image\n\n        outputMetadatas.push(metadata)\n      }\n\n      let outputFormat = urlFormat()\n\n      for (const [key, format] of Object.entries(outputFormats)) {\n        if (directives.has(key)) {\n          const params = directives\n            .get(key)\n            ?.split(';')\n            .filter((v: string) => !!v)\n          outputFormat = format(params?.length ? params : undefined)\n          break\n        }\n      }\n\n      return dataToEsm(outputFormat(outputMetadatas), {\n        namedExports: viteConfig.json?.namedExports ?? true,\n        compact: !!viteConfig.build.minify ?? false,\n        preferConst: true\n      })\n    },\n\n    configureServer(server) {\n      server.middlewares.use((req, res, next) => {\n        if (req.url?.startsWith('/@imagetools/')) {\n          const [, id] = req.url.split('/@imagetools/')\n\n          const image = generatedImages.get(id)\n\n          if (!image)\n            throw new Error(`vite-imagetools cannot find image with id \"${id}\" this is likely an internal error`)\n\n          if (pluginOptions.removeMetadata === false) {\n            image.withMetadata()\n          }\n\n          res.setHeader('Content-Type', `image/${getMetadata(image, 'format')}`)\n          res.setHeader('Cache-Control', 'max-age=360000')\n          return image.clone().pipe(res)\n        }\n\n        next()\n      })\n    }\n  }\n}\n"],"names":["createFilter","builtins","builtinOutputFormats","parseURL","extractEntries","resolveConfigs","loadImage","generateImageID","generateTransforms","applyTransforms","basename","extname","posix","urlFormat","dataToEsm","getMetadata"],"mappings":"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"}